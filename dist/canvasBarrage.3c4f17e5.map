{"version":3,"sources":["canvasBarrage.js"],"names":["CanvasBarrage","canvas","video","options","defaults","opacity","fontSize","speed","range","color","data","params","key","top","length","context","getContext","width","clientWidth","height","clientHeight","store","isPause","time","currentTime","Barrage","obj","value","init","hasOwnProperty","div","document","createElement","style","backgroundColor","body","appendChild","c","window","getComputedStyle","removeChild","span","position","whiteSpace","font","innerText","textContent","x","actualX","y","Math","random","moveX","draw","shadowColor","shadowBlur","test","fillStyle","split","fillText","forEach","index","barrage","disabled","inited","render","clearRect","requestAnimationFrame","addEventListener","reset","add","Object","keys"],"mappings":"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","file":"canvasBarrage.3c4f17e5.map","sourcesContent":["/*!\n** by zhangxinxu(.com)\n** 与HTML5 video视频真实交互的弹幕效果\n** http://www.zhangxinxu.com/wordpress/?p=6386\n** MIT License\n** 保留版权申明\n*/\nvar CanvasBarrage = function (canvas, video, options) {\n\tif (!canvas || !video) {\n\t\treturn;\t\n\t}\n\tvar defaults = {\n\t\topacity: 100,\n\t\tfontSize: 24,\n\t\tspeed: 2,\n\t\trange: [0,1],\n\t\tcolor: 'white',\n\t\tdata: []\n\t};\n\t\n\toptions = options || {};\n\t\n\tvar params = {};\n\t// 参数合并\n\tfor (var key in defaults) {\n\t\tif (options[key]) {\n\t\t\tparams[key] = options[key];\n\t\t} else {\n\t\t\tparams[key] = defaults[key];\n\t\t}\n\t\t\n\t\tthis[key] = params[key];\n\t}\n\tvar top = this;\n\tvar data = top.data;\n\t\n\tif (!data || !data.length) {\n\t\treturn;\n\t}\n\n\tvar context = canvas.getContext('2d');\n\tcanvas.width = canvas.clientWidth;\n\tcanvas.height = canvas.clientHeight;\n\n\t// 存储实例\n\tvar store = {};\n\t\n\t// 暂停与否\n\tvar isPause = true;\n\t// 播放时长\n\tvar time = video.currentTime;\n\n\t// 字号大小\n\tvar fontSize = 28;\n\n\t// 实例方法\n\tvar Barrage = function (obj) {\n\t\t// 一些变量参数\n\t\tthis.value = obj.value;\n\t\tthis.time = obj.time;\n\t\t// data中的可以覆盖全局的设置\n\t\tthis.init = function () {\n\t\t\t// 1. 速度\n\t\t\tvar speed = top.speed;\n\t\t\tif (obj.hasOwnProperty('speed')) {\n\t\t\t\tspeed = obj.speed;\n\t\t\t}\n\t\t\tif (speed !== 0) {\n\t\t\t\t// 随着字数不同，速度会有微调\n\t\t\t\tspeed = speed + obj.value.length / 100;\n\t\t\t}\n\t\t\t// 2. 字号大小\n\t\t\tvar fontSize = obj.fontSize || top.fontSize;\n\n\t\t\t// 3. 文字颜色\n\t\t\tvar color = obj.color || top.color;\n\t\t\t// 转换成rgb颜色\n\t\t\tcolor = (function () {\n\t\t\t\tvar div = document.createElement('div');\n\t\t\t\tdiv.style.backgroundColor = color;\n\t\t\t\tdocument.body.appendChild(div);\n\t\t\t\tvar c = window.getComputedStyle(div).backgroundColor;\t\n\t\t\t\tdocument.body.removeChild(div);\n\t\t\t\treturn c;\n\t\t\t})();\n\t\t\t\n\t\t\t// 4. range范围\n\t\t\tvar range = obj.range || top.range;\n\t\t\t// 5. 透明度\n\t\t\tvar opacity = obj.opacity || top.opacity;\n\t\t\topacity = opacity / 100;\n\t\t\t\n\t\t\t// 计算出内容长度\n\t\t\tvar span = document.createElement('span');\n\t\t\tspan.style.position = 'absolute';\n\t\t\tspan.style.whiteSpace = 'nowrap';\n\t\t\tspan.style.font = 'bold ' + fontSize + 'px \"microsoft yahei\", sans-serif';\n\t\t\tspan.innerText = obj.value;\n\t\t\tspan.textContent = obj.value;\n\t\t\tdocument.body.appendChild(span);\n\t\t\t// 求得文字内容宽度\n\t\t\tthis.width = span.clientWidth;\n\t\t\t// 移除dom元素\n\t\t\tdocument.body.removeChild(span);\n\t\t\t\n\t\t\t// 初始水平位置和垂直位置\n\t\t\tthis.x = canvas.width;\n\t\t\tif (speed == 0) {\n\t\t\t\tthis.x\t= (this.x - this.width) / 2;\n\t\t\t}\n\t\t\tthis.actualX = canvas.width;\n\t\t\tthis.y = range[0] * canvas.height + (range[1] - range[0]) * canvas.height * Math.random();\n\t\t\tif (this.y < fontSize) {\n\t\t\t\tthis.y = fontSize;\n\t\t\t} else if (this.y > canvas.height - fontSize) {\n\t\t\t\tthis.y = canvas.height - fontSize;\n\t\t\t}\n\t\t\t\n\t\t\tthis.moveX = speed;\n\t\t\tthis.opacity = opacity;\n\t\t\tthis.color = color;\n\t\t\tthis.range = range;\n\t\t\tthis.fontSize = fontSize;\t\n\t\t};\n\t\t\n\t\tthis.draw = function () {\t\t\t\n\t\t\t// 根据此时x位置绘制文本\n\t\t\tcontext.shadowColor = 'rgba(0,0,0,'+ this.opacity +')';\n\t\t\tcontext.shadowBlur = 2;\n\t\t\tcontext.font = this.fontSize + 'px \"microsoft yahei\", sans-serif';\n\t\t\tif (/rgb\\(/.test(this.color)) {\n\t\t\t\tcontext.fillStyle = 'rgba('+ this.color.split('(')[1].split(')')[0] +','+ this.opacity +')';\n\t\t\t} else {\n\t\t\t\tcontext.fillStyle = this.color;\t\n\t\t\t}\n\t\t\t// 填色\n\t\t\tcontext.fillText(this.value, this.x, this.y);\n\t\t};\n\t};\n\n\tdata.forEach(function (obj, index) {\n\t\tstore[index] = new Barrage(obj);\n\t});\n\n\t// 绘制弹幕文本\n\tvar draw = function () {\n\t\tfor (var index in store) {\n\t\t\tvar barrage = store[index];\n\t\t\t\n\t\t\tif (barrage && !barrage.disabled && time >= barrage.time) {\n\t\t\t\tif (!barrage.inited) {\n\t\t\t\t\tbarrage.init();\n\t\t\t\t\tbarrage.inited = true;\n\t\t\t\t}\n\t\t\t\tbarrage.x -= barrage.moveX;\n\t\t\t\tif (barrage.moveX == 0) {\n\t\t\t\t\t// 不动的弹幕\n\t\t\t\t\tbarrage.actualX -= top.speed;\n\t\t\t\t} else {\n\t\t\t\t\tbarrage.actualX = barrage.x;\n\t\t\t\t}\n\t\t\t\t// 移出屏幕\n\t\t\t\tif (barrage.actualX < -1 * barrage.width) {\n\t\t\t\t\t// 下面这行给speed为0的弹幕\n\t\t\t\t\tbarrage.x = barrage.actualX;\n\t\t\t\t\t// 该弹幕不运动\n\t\t\t\t\tbarrage.disabled = true;\n\t\t\t\t}\n\t\t\t\t// 根据新位置绘制圆圈圈\n\t\t\t\tbarrage.draw();\t\n\t\t\t}\n\t\t}\n\t};\n\t\n\t// 画布渲染\n\tvar render = function () {\n\t\t// 更新已经播放时间\n\t\ttime = video.currentTime;\n\t\t// 清除画布\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\t\t\n\t\t// 绘制画布\n\t\tdraw();\n\n\t\t// 继续渲染\n\t\tif (isPause == false) {\n\t\t\trequestAnimationFrame(render);\n\t\t}\n\t};\n\t\n\t// 视频处理\n\tvideo.addEventListener('play', function () {\n\t\tisPause = false;\n\t\trender();\n\t});\n\tvideo.addEventListener('pause', function () {\n\t\tisPause = true;\n\t});\n\tvideo.addEventListener('seeked', function () {\n\t\t// 跳转播放需要清屏\n\t\ttop.reset();\n\t});\n\t\n\t\n\t// 添加数据的方法 \n\tthis.add = function (obj) {\n\t\tstore[Object.keys(store).length] = new Barrage(obj);\n\t};\n\t\n\t// 重置\n\tthis.reset = function () {\n\t\ttime = video.currentTime;\n\t\t// 画布清除\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\t\t\n\t\tfor (var index in store) {\n\t\t\tvar barrage = store[index];\n\t\t\tif (barrage) {\n\t\t\t\t// 状态变化\n\t\t\t\tbarrage.disabled = false;\n\t\t\t\t// 根据时间判断哪些可以走起\n\t\t\t\tif (time < barrage.time) {\n\t\t\t\t\t// 视频时间小于播放时间\n\t\t\t\t\t// barrage.disabled = true;\n\t\t\t\t\tbarrage.inited = null;\n\t\t\t\t} else {\n\t\t\t\t\t// 视频时间大于播放时间\n\t\t\t\t\tbarrage.disabled = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n};"]}